<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient View | CURVE</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Outfit:wght@300;400;500;600&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary-color: #14bfce;
            --primary-dark: #0e9aa7;
            --secondary-color: #2c3e50;
            --text-dark: #2c3e50;
            --text-light: #95a5a6;
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: 1px solid rgba(255, 255, 255, 0.5);
            --bg-gradient: radial-gradient(circle at 10% 20%, rgb(239, 246, 249) 0%, rgb(215, 240, 252) 90%);
        }

        body {
            margin: 0;
            padding: 0;
            background: var(--bg-gradient);
            font-family: 'Outfit', sans-serif;
            color: var(--text-dark);
            min-height: 100vh;
            overflow-x: hidden;
            overflow-y: auto;
        }

        /* Premium Header */
        .dashboard-header {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            height: 80px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            z-index: 1000;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 40px;
        }

        .logo-img {
            height: 40px;
            mix-blend-mode: multiply;
        }

        .nav-links {
            display: flex;
            gap: 20px;
        }

        .nav-item {
            text-decoration: none;
            color: var(--text-dark);
            opacity: 0.7;
            font-weight: 500;
            font-size: 0.95rem;
            padding: 10px 18px;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        /* Only for patient view, maybe no hover effect needed for title */
        .page-indicator {
            background: rgba(20, 191, 206, 0.1);
            color: var(--primary-color);
            padding: 8px 20px;
            border-radius: 30px;
            font-weight: 600;
            border: 1px solid rgba(20, 191, 206, 0.2);
            font-size: 0.9rem;
            letter-spacing: 0.5px;
        }

        /* Layout Container to account for fixed header */
        .layout-container {
            display: flex;
            height: 100vh;
            padding-top: 120px;
            /* Header height + gap */
        }

        /* Sidebar Glass Panel */
        .sidebar {
            width: 300px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            /* Standard visible sidebar */
            position: sticky;
            top: 120px;
            /* Offset for header */
            height: auto;
            max-height: calc(100vh - 140px);
            overflow-y: auto;
            /* Internal scroll if needed */
            border-radius: 24px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            padding: 30px;
            gap: 15px;
            z-index: 90;
            border: 1px solid rgba(255, 255, 255, 0.6);
            margin-left: 20px;
            /* Add margin-left to align with header */
        }

        .patient-info-card {
            background: #f8f9fa;
            border-radius: 18px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.03);
            border: 1px solid rgba(0, 0, 0, 0.03);
        }

        .patient-info-row {
            font-size: 0.9rem;
            color: var(--text-dark);
            margin-bottom: 8px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
        }

        .patient-info-row span {
            color: var(--primary-color);
            font-weight: 500;
        }

        /* Modern Nav Buttons */
        .nav-btn {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 14px 20px;
            background: transparent;
            border: none;
            border-radius: 14px;
            cursor: pointer;
            font-family: 'Outfit', sans-serif;
            font-size: 1rem;
            color: var(--text-light);
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            text-align: left;
        }

        .nav-btn:hover {
            background: rgba(20, 191, 206, 0.08);
            color: var(--primary-color);
            transform: translateX(5px);
        }

        .nav-btn.active {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            box-shadow: 0 8px 20px rgba(20, 191, 206, 0.3);
            font-weight: 600;
        }

        .nav-icon {
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 0 0 40px 40px;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        #viewTitle {
            font-family: 'Montserrat', sans-serif;
            font-size: 2rem;
            color: var(--text-dark);
            margin-bottom: 30px;
            font-weight: 700;
            position: relative;
            display: inline-block;
        }

        #viewTitle::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: -10px;
            width: 60px;
            height: 4px;
            background: var(--primary-color);
            border-radius: 2px;
        }

        .viewer-container {
            width: 100%;
            display: flex;
            justify-content: flex-start;
            flex-wrap: wrap;
            gap: 25px;
            padding-bottom: 40px;
        }

        /* Media Grid */
        .media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 30px;
            width: 100%;
        }

        .media-item {
            background: white;
            border-radius: 20px;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            transition: all 0.4s ease;
            cursor: pointer;
            position: relative;
            border: 1px solid rgba(0, 0, 0, 0.02);
            animation: fadeIn 0.6s ease forwards;
            opacity: 0;
            transform: translateY(20px);
        }

        .media-item:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .media-item img,
        .media-item video {
            width: 100%;
            height: 220px;
            object-fit: cover;
            border-radius: 12px;
            background: #f8f9fa;
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Split View Enhancement */
        .split-view {
            display: flex;
            width: 100%;
            height: calc(100vh - 250px);
            gap: 30px;
        }

        .split-panel {
            flex: 1;
            background: white;
            border-radius: 24px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            padding: 20px;
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(0, 0, 0, 0.02);
        }

        .split-title {
            font-size: 1.1rem;
            color: var(--primary-color);
            margin-bottom: 20px;
            text-align: center;
            letter-spacing: 1px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .split-content {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            scrollbar-width: thin;
            scrollbar-color: #d1d8e0 transparent;
        }

        .empty-state {
            width: 100%;
            height: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #bdc3c7;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 24px;
            border: 2px dashed #e0e0e0;
        }

        .error-message {
            max-width: 600px;
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
    </style>
    <script src="https://unpkg.com/three@0.128.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/loaders/STLLoader.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/loaders/PLYLoader.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/loaders/OBJLoader.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
</head>

<body>
    <!-- Premium Header -->
    <header class="dashboard-header">
        <div class="header-left">
            <img src="assets/logo curve.jpg" alt="Curve Logo" class="logo-img">
            <div class="page-indicator">Patient Review Portal</div>
        </div>
        <!-- Minimal header for patient -->
    </header>

    <div class="layout-container" id="mainContainer" style="display:none;">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="patient-info-card">
                <div class="patient-info-row">Patient Name : <span id="pName"></span></div>
                <div class="patient-info-row">Age : <span id="pAge"></span> Sex : <span id="pSex"></span></div>
            </div>

            <button class="nav-btn active" onclick="showTab('images', this)">
                <span class="nav-icon">üì∑</span> Images
            </button>
            <button class="nav-btn" onclick="showTab('pdf', this)">
                <span class="nav-icon">üìÑ</span> Plan Pdf
            </button>
            <button class="nav-btn" onclick="showTab('video', this)">
                <span class="nav-icon">‚ñ∂Ô∏è</span> Video
            </button>
            <button class="nav-btn" onclick="showTab('face3d', this)">
                <span class="nav-icon">üë§</span> Face 3d
            </button>
            <button class="nav-btn" onclick="showTab('compare', this)">
                <span class="nav-icon">üßä</span> 3d Compare
            </button>

            <div style="flex:1;"></div>
        </aside>

        <!-- Main Viewer Area -->
        <main class="main-content">
            <h2 id="viewTitle">Images</h2>
            <div id="viewer" class="viewer-container">
                <!-- Dynamic Content -->
            </div>
        </main>
    </div>

    <!-- Error/Loading Container -->
    <div id="statusContainer" style="height: 100vh; display: flex; align-items: center; justify-content: center;">
        <div class="empty-state">Loading patient data...</div>
    </div>

    <script>
        let p = {}; // Current patient data

        document.addEventListener('DOMContentLoaded', function () {
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');
            const view = urlParams.get('view') || 'preop';

            if (!id) {
                showError('Invalid Link', 'This link is missing the Patient ID.');
                return;
            }

            // Fetch from Server API
            fetch(`/api/patient/${id}`)
                .then(response => {
                    if (!response.ok) throw new Error(response.status === 404 ? 'Patient not found' : 'Server error');
                    return response.json();
                })
                .then(patient => {
                    p = patient;
                    initializeView(view);
                })
                .catch(err => {
                    console.error('Load error:', err);
                    showError('Connection Failed', 'Could not load patient data. <br>Ensure the server is accessible.<br><small>' + err.message + '</small>');
                });
        });

        function initializeView(initialView) {
            document.getElementById('statusContainer').style.display = 'none';
            document.getElementById('mainContainer').style.display = 'flex';

            // Populate Info
            document.getElementById('pName').textContent = p.name || 'N/A';
            document.getElementById('pAge').textContent = p.age || 'N/A';
            document.getElementById('pSex').textContent = p.sex || 'N/A';

            // Find valid tab button or default
            let btn = document.querySelector(`button[onclick="showTab('${initialView}', this)"]`);
            if (!btn) {
                // heuristic fallback if view param is mismatch
                if (initialView === 'preop') btn = document.querySelectorAll('.nav-btn')[5];
                else btn = document.querySelectorAll('.nav-btn')[0];
            }

            showTab(initialView, btn);
        }

        function showError(title, message) {
            const container = document.getElementById('statusContainer');
            container.innerHTML = `
                <div class="error-message">
                    <h2 style="color:#e74c3c;">${title}</h2>
                    <p>${message}</p>
                </div>
            `;
        }

        function showTab(type, btn) {
            // Active state
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');

            const viewer = document.getElementById('viewer');
            const title = document.getElementById('viewTitle');
            viewer.innerHTML = '';

            let paths = [];

            if (type === 'images') {
                title.textContent = 'Images';
                paths = [
                    ...(p.planningStlPaths || []),
                    ...(p.extraPaths || []),
                    ...(p.intraPaths || []),
                    ...(p.extraPathsPhase2 || []),
                    ...(p.intraPathsPhase2 || []),
                    ...(p.scanPaths || []),
                    ...(p.scanPathsPhase2 || [])
                ];
                renderGrid(paths);
            } else if (type === 'pdf') {
                title.textContent = 'Plan PDF';
                paths = p.planningPdfPaths2 || [];
                renderGrid(paths);
            } else if (type === 'video') {
                title.textContent = 'Plan Video';
                paths = [
                    ...(p.planningVideoPaths2 || []),
                    ...(p.facePaths || []),
                    ...(p.facePathsPhase2 || [])
                ];
                renderGrid(paths);
            } else if (type === 'face3d') {
                title.textContent = 'Face 3D Analysis';
                paths = p.planningFace3dPaths2 || [];
                renderGrid(paths);
            } else if (type === 'compare') {
                title.textContent = '3D Comparison';
                render3DCompare(p);
            } else if (type === 'preop') {
                title.textContent = 'Pre-Op Clinicals';
                paths = [
                    ...(p.planningPreoptPaths || []),
                    ...(p.extraPaths || []),
                    ...(p.intraPaths || []),
                    ...(p.extraPathsPhase2 || []),
                    ...(p.intraPathsPhase2 || [])
                ];
                renderGrid(paths);
            }
        }

        function renderGrid(paths) {
            const viewer = document.getElementById('viewer');
            if (!paths.length) {
                viewer.innerHTML = '<div class="empty-state">No files uploaded for this section.</div>';
                return;
            }

            const grid = document.createElement('div');
            grid.className = 'media-grid';

            paths.forEach((path, index) => {
                if (!path) return;
                const item = document.createElement('div');
                item.className = 'media-item';
                item.style.animationDelay = `${index * 0.1}s`;

                const ext = path.split('.').pop().toLowerCase();
                const isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext);
                const isVideo = ['mp4', 'webm', 'mov', 'avi'].includes(ext);
                const isPdf = ext === 'pdf';
                const is3d = ['stl', 'obj', 'ply'].includes(ext);

                if (isImage) {
                    const img = document.createElement('img');
                    img.src = path;
                    img.onclick = () => window.open(path, '_blank');
                    item.appendChild(img);
                } else if (isVideo) {
                    const vid = document.createElement('video');
                    vid.src = path;
                    vid.controls = true;
                    vid.style.width = '100%';
                    vid.style.height = '200px';
                    vid.style.borderRadius = '12px';
                    item.appendChild(vid);
                } else if (isPdf) {
                    const chip = document.createElement('div');
                    chip.className = 'file-chip';
                    chip.style.padding = '20px';
                    chip.style.textAlign = 'center';
                    chip.style.background = '#f8f9fa';
                    chip.style.borderRadius = '12px';
                    chip.innerHTML = `üìÑ PDF Document<br><small style="color:#7f8c8d">Click to View</small>`;
                    chip.onclick = () => window.open(path, '_blank');
                    item.appendChild(chip);
                } else if (is3d) {
                    const canvasContainer = document.createElement('div');
                    canvasContainer.style.width = '100%';
                    canvasContainer.style.height = '220px';
                    canvasContainer.style.background = '#f8f9fa';
                    canvasContainer.style.borderRadius = '12px';
                    canvasContainer.style.position = 'relative';
                    canvasContainer.style.overflow = 'hidden';
                    item.appendChild(canvasContainer);

                    const label = document.createElement('div');
                    label.textContent = path.split(/[/\\]/).pop();
                    label.style.position = 'absolute';
                    label.style.bottom = '5px';
                    label.style.left = '5px';
                    label.style.fontSize = '10px';
                    label.style.background = 'rgba(255,255,255,0.7)';
                    label.style.padding = '2px 5px';
                    label.style.borderRadius = '4px';
                    label.style.zIndex = '5';
                    canvasContainer.appendChild(label);

                    // Initialize mini 3D viewer
                    setTimeout(() => initMiniViewer(canvasContainer, path), 100);
                } else {
                    const link = document.createElement('a');
                    link.href = path;
                    link.textContent = 'View File';
                    link.target = '_blank';
                    item.appendChild(link);
                }
                grid.appendChild(item);
            });
            viewer.appendChild(grid);
        }

        function renderSplit(leftPaths, rightPaths, leftLabel, rightLabel) {
            const viewer = document.getElementById('viewer');

            if (!leftPaths.length && !rightPaths.length) {
                viewer.innerHTML = '<div class="empty-state">No comparison data available.</div>';
                return;
            }

            const container = document.createElement('div');
            container.className = 'split-view';

            const buildPanel = (paths, label) => {
                const panel = document.createElement('div');
                panel.className = 'split-panel';

                panel.innerHTML = `<div class="split-title">${label}</div>`;

                const content = document.createElement('div');
                content.className = 'split-content';

                if (paths.length) {
                    paths.forEach(path => {
                        const img = document.createElement('img');
                        img.src = path;
                        img.style.maxWidth = '100%';
                        img.style.borderRadius = '12px';
                        img.style.boxShadow = '0 4px 15px rgba(0,0,0,0.05)';
                        img.style.marginBottom = '20px';
                        content.appendChild(img);
                    });
                } else {
                    content.innerHTML = '<div style="color:#bdc3c7; margin-top:40px;">No images</div>';
                }

                panel.appendChild(content);
                return panel;
            };

            container.appendChild(buildPanel(leftPaths, leftLabel));
            container.appendChild(buildPanel(rightPaths, rightLabel));
            viewer.appendChild(container);
        }

        function render3DCompare(patient) {
            const viewer = document.getElementById('viewer');
            viewer.innerHTML = '';

            if (typeof THREE === 'undefined') {
                viewer.innerHTML = '<div class="empty-state">Loading 3D Engine...</div>';
                return;
            }

            // Grid Container
            const grid = document.createElement('div');
            grid.style.display = 'grid';
            grid.style.gridTemplateColumns = 'repeat(auto-fit, minmax(400px, 1fr))';
            grid.style.gap = '25px';
            grid.style.width = '100%';
            grid.style.paddingBottom = '40px';
            viewer.appendChild(grid);

            if (window.compareReqId) cancelAnimationFrame(window.compareReqId);

            const updatables = [];

            // Definitions: Separate boxes
            const views = [
                { label: 'Pre-Op Upper', paths: patient.comparePreOpUpper, color: 0xffffff },
                { label: 'Pre-Op Lower', paths: patient.comparePreOpLower, color: 0xffffff },
                { label: 'Post-Op Upper', paths: patient.comparePostOpUpper, color: 0x4dd0e1 },
                { label: 'Post-Op Lower', paths: patient.comparePostOpLower, color: 0x4dd0e1 }
            ];

            views.forEach((def) => {
                const cell = document.createElement('div');
                cell.style.background = '#ffffff';
                cell.style.borderRadius = '20px';
                cell.style.overflow = 'hidden';
                cell.style.position = 'relative';
                cell.style.height = '400px';
                cell.style.boxShadow = '0 10px 30px rgba(0,0,0,0.05)';
                cell.style.border = '1px solid rgba(0,0,0,0.03)';
                grid.appendChild(cell);

                const label = document.createElement('div');
                label.textContent = def.label;
                label.style.position = 'absolute';
                label.style.top = '20px';
                label.style.left = '20px';
                label.style.background = 'rgba(255,255,255,0.95)';
                label.style.padding = '8px 16px';
                label.style.borderRadius = '30px';
                label.style.fontWeight = '700';
                label.style.fontSize = '0.9rem';
                label.style.zIndex = '10';
                label.style.color = '#2c3e50';
                label.style.boxShadow = '0 4px 10px rgba(0,0,0,0.05)';
                cell.appendChild(label);

                if (!def.paths || !def.paths.length) {
                    const empty = document.createElement('div');
                    empty.textContent = 'No 3D Model';
                    empty.style.width = '100%';
                    empty.style.height = '100%';
                    empty.style.display = 'flex';
                    empty.style.alignItems = 'center';
                    empty.style.justifyContent = 'center';
                    empty.style.color = '#bdc3c7';
                    empty.style.fontWeight = '500';
                    cell.appendChild(empty);
                    return;
                }

                // 3D Setup
                const scene = new THREE.Scene();
                scene.background = new THREE.Color(0xfcfcfc);

                const w = cell.clientWidth || 400;
                const h = 400;

                const camera = new THREE.PerspectiveCamera(45, w / h, 1, 1000);
                camera.position.set(0, -150, 100);

                // --- Improved Lighting System ---
                // 1. Hemisphere Light
                const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 0.8);
                scene.add(hemiLight);

                // 2. Directional Light
                const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
                dirLight.position.set(50, 50, 100);
                scene.add(dirLight);

                // 3. Camera Light
                const camLight = new THREE.PointLight(0xffffff, 0.5);
                camera.add(camLight);
                scene.add(camera);

                const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, preserveDrawingBuffer: true });
                renderer.setSize(w, h);
                renderer.setPixelRatio(window.devicePixelRatio);
                cell.appendChild(renderer.domElement);

                const controls = new THREE.OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                controls.dampingFactor = 0.05;
                controls.enableZoom = true;
                controls.autoRotate = true; // Enable Auto Rotation
                controls.autoRotateSpeed = 2.0;

                // Toggle Auto-Rotate Button
                const rotateBtn = document.createElement('button');
                rotateBtn.innerHTML = 'üîÑ Auto-Rotate: ON';
                rotateBtn.style.position = 'absolute';
                rotateBtn.style.bottom = '10px';
                rotateBtn.style.right = '10px';
                rotateBtn.style.zIndex = '10';
                rotateBtn.style.border = 'none';
                rotateBtn.style.background = 'rgba(20, 191, 206, 0.1)';
                rotateBtn.style.color = '#14bfce';
                rotateBtn.style.padding = '5px 10px';
                rotateBtn.style.borderRadius = '15px';
                rotateBtn.style.fontSize = '0.8rem';
                rotateBtn.style.cursor = 'pointer';
                rotateBtn.style.fontWeight = '600';

                rotateBtn.onclick = () => {
                    controls.autoRotate = !controls.autoRotate;
                    rotateBtn.innerHTML = controls.autoRotate ? 'üîÑ Auto-Rotate: ON' : 'üîÑ Auto-Rotate: OFF';
                    rotateBtn.style.background = controls.autoRotate ? 'rgba(20, 191, 206, 0.1)' : '#eee';
                    rotateBtn.style.color = controls.autoRotate ? '#14bfce' : '#7f8c8d';
                };
                cell.appendChild(rotateBtn);

                // Load STL
                const loader = new THREE.STLLoader();
                def.paths.forEach(p => {
                    loader.load(p, (geo) => {
                        geo.computeBoundingSphere();
                        const center = geo.boundingSphere.center;
                        geo.translate(-center.x, -center.y, -center.z);

                        const mat = new THREE.MeshPhongMaterial({
                            color: def.color,
                            specular: 0x111111,
                            shininess: 30,
                            side: THREE.DoubleSide
                        });
                        const mesh = new THREE.Mesh(geo, mat);
                        scene.add(mesh);
                    });
                });

                updatables.push({ renderer, scene, camera, controls, cell });
            });

            const animate = () => {
                window.compareReqId = requestAnimationFrame(animate);
                updatables.forEach(u => {
                    u.controls.update();

                    const w = u.cell.clientWidth;
                    const h = u.cell.clientHeight;
                    const canvas = u.renderer.domElement;
                    if (canvas.width !== w || canvas.height !== h) {
                        u.renderer.setSize(w, h);
                        u.camera.aspect = w / h;
                        u.camera.updateProjectionMatrix();
                    }

                    u.renderer.render(u.scene, u.camera);
                });
            };
            animate();
        }

        function initMiniViewer(container, path) {
            const w = container.clientWidth;
            const h = container.clientHeight;

            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf8f9fa);

            const camera = new THREE.PerspectiveCamera(45, w / h, 0.1, 1000);
            camera.position.set(0, 0, 100);

            const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(w, h);
            renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(renderer.domElement);

            const controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.autoRotate = true;
            controls.autoRotateSpeed = 4;

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
            scene.add(ambientLight);
            const pointLight = new THREE.PointLight(0xffffff, 0.8);
            camera.add(pointLight);
            scene.add(camera);

            const ext = path.split('.').pop().toLowerCase();
            let loader;
            if (ext === 'stl') loader = new THREE.STLLoader();
            else if (ext === 'ply') loader = new THREE.PLYLoader();
            else if (ext === 'obj') loader = new THREE.OBJLoader();

            if (loader) {
                loader.load(path, (obj) => {
                    let geometry;
                    if (obj.isBufferGeometry) {
                        geometry = obj;
                    } else {
                        obj.traverse(child => {
                            if (child.isMesh) geometry = child.geometry;
                        });
                    }

                    if (geometry) {
                        geometry.computeBoundingBox();
                        geometry.computeBoundingSphere();
                        const center = geometry.boundingSphere.center;
                        geometry.translate(-center.x, -center.y, -center.z);

                        const material = new THREE.MeshPhongMaterial({ color: 0x14bfce, specular: 0x111111, shininess: 30 });
                        const mesh = new THREE.Mesh(geometry, material);
                        scene.add(mesh);

                        const size = geometry.boundingBox.getSize(new THREE.Vector3()).length();
                        camera.position.z = size * 1.5;
                    } else if (obj.isGroup || obj.isObject3D) {
                        scene.add(obj);
                    }
                });
            }

            function animate() {
                if (!document.body.contains(container)) return;
                requestAnimationFrame(animate);
                controls.update();
                renderer.render(scene, camera);
            }
            animate();
        }
    </script>
</body>

</html>