<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Planning - Phase 2 | x3dental</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Outfit:wght@300;400;500;600&display=swap"
        rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: radial-gradient(circle at 10% 20%, rgb(239, 246, 249) 0%, rgb(215, 240, 252) 90%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Header */
        .page-header {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            height: 160px;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            z-index: 100;
        }

        .logo-img {
            height: 120px;
            /* mix-blend-mode: multiply; */
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 40px;
        }

        .nav-links {
            display: flex;
            gap: 20px;
        }

        .nav-item {
            text-decoration: none;
            color: #546e7a;
            font-weight: 500;
            font-size: 0.95rem;
            padding: 10px 18px;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .nav-item:hover,
        .nav-item.active {
            background: rgba(20, 191, 206, 0.1);
            color: #14bfce;
            font-weight: 600;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .back-btn-header {
            padding: 10px 20px;
            background: #2c3e50;
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
        }

        .back-btn-header:hover {
            background: #34495e;
            transform: translateX(-3px);
        }

        .branch-badge {
            background: rgba(44, 62, 80, 0.05);
            padding: 10px 25px;
            border-radius: 30px;
            font-weight: 600;
            font-size: 0.9rem;
            color: #2c3e50;
            border: 1px solid rgba(44, 62, 80, 0.1);
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        /* Main Container */
        .main-container {
            margin-top: 200px;
            padding: 20px 40px 40px;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }

        .page-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 2.5rem;
            color: #2c3e50;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .phase-badge {
            display: inline-block;
            background: linear-gradient(135deg, #14bfce, #0e9aa7);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 30px;
        }

        /* Patient Info Card */
        .patient-info-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .info-label {
            font-size: 0.85rem;
            color: #7f8c8d;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-value {
            font-size: 1.05rem;
            color: #2c3e50;
            font-weight: 600;
        }

        /* Form Section */
        .form-section {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        .section-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.5rem;
            color: #2c3e50;
            margin-bottom: 25px;
            font-weight: 700;
        }

        /* Upload Section */
        .upload-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .upload-item {
            background: rgba(20, 191, 206, 0.05);
            border: 2px dashed #14bfce;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .upload-item:hover {
            background: rgba(20, 191, 206, 0.1);
            border-color: #0e9aa7;
        }

        .upload-label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
            display: block;
        }

        .upload-btn {
            background: #14bfce;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .upload-btn:hover {
            background: #0e9aa7;
            transform: translateY(-2px);
        }

        .thumb-strip {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }

        .media-container {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            border: 1px solid #ddd;
            padding: 5px;
            border-radius: 8px;
            background: #fff;
        }

        .media-container img,
        .media-container video {
            width: 80px;
            height: 60px;
            object-fit: cover;
            cursor: pointer;
            border-radius: 4px;
        }

        .download-btn {
            text-decoration: none;
            color: #14bfce;
            font-size: 1.2em;
            cursor: pointer;
            margin-top: 4px;
        }

        .file-chip {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #14bfce;
            background: #f5fbff;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-chip:hover {
            background: #14bfce;
            color: white;
        }

        /* Action Buttons */
        .form-actions {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #ecf0f1;
        }

        .action-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .btn-back {
            background: #95a5a6;
        }

        .btn-save-next {
            background: linear-gradient(135deg, #14bfce, #0e9aa7);
        }

        .btn-label {
            margin-top: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            color: #2c3e50;
        }

        input[type="file"] {
            display: none;
        }

        .media-container,
        .local-preview {
            position: relative;
            display: inline-block;
            margin-right: 10px;
            margin-top: 10px;
        }

        .remove-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 22px;
            height: 22px;
            background: #ff5252;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 10;
            transition: all 0.2s ease;
            font-weight: bold;
            line-height: 1;
        }

        .remove-btn:hover {
            background: #d32f2f;
            transform: scale(1.1);
        }

        .progress-indicator {
            font-size: 0.75rem;
            color: #27ae60;
            margin-top: 5px;
            display: block;
        }

        /* Mobile Optimization */
        @media (max-width: 768px) {
            .page-header {
                height: auto;
                padding: 10px 15px;
                flex-direction: row;
                justify-content: space-between;
                gap: 15px;
                background: rgba(255, 255, 255, 0.98);
                top: 10px;
                left: 10px;
                right: 10px;
            }

            .header-left {
                flex-direction: row;
                gap: 20px;
                width: auto;
                flex: 1;
                overflow: hidden;
            }

            .nav-links {
                display: flex;
                flex-wrap: nowrap;
                overflow-x: auto;
                width: 100%;
                justify-content: flex-start;
                padding: 5px 0;
                gap: 5px;
                -webkit-overflow-scrolling: touch;
            }

            .nav-links::-webkit-scrollbar {
                display: none;
            }

            .nav-item {
                white-space: nowrap;
                padding: 6px 10px;
                font-size: 0.8rem;
                flex-shrink: 0;
            }

            .header-right {
                width: auto;
                gap: 10px;
                margin-top: 0;
            }

            .back-btn-header span:last-child {
                display: none;
            }

            .back-btn-header {
                padding: 8px 12px;
            }

            .branch-badge {
                font-size: 0.75rem;
                padding: 6px 12px;
                white-space: nowrap;
                margin-top: 0;
            }

            .main-container {
                margin-top: 200px;
                padding: 15px;
            }

            .info-grid,
            .upload-grid {
                grid-template-columns: 1fr;
            }

            .page-title {
                font-size: 1.8rem;
            }

            .section-title {
                font-size: 1.4rem;
            }
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header class="page-header">
        <div class="header-left">
            <img src="assets/logo-transparent.png" alt="x3dental" class="logo-img">
            <nav class="nav-links">
                <a href="dashboard.html" class="nav-item">Dashboard</a>
                <a href="book-appointment.html" class="nav-item">Book Appointment</a>
                <a href="check-appointment.html" class="nav-item">Check Appointment</a>
                <a href="patient-entry.html" class="nav-item">Entry</a>
                <a href="patient-planning-list.html" class="nav-item active">Planning</a>
                <a href="patient-interaction-list.html" class="nav-item">Interaction</a>
            </nav>
        </div>
        <div class="header-right">
            <button class="back-btn-header" onclick="window.location.href='patient-planning-list.html'">
                <span>‚Üê</span>
                <span>Back</span>
            </button>
            <div class="branch-badge" id="branch-display">Branch</div>
        </div>
    </header>

    <div class="main-container">
        <h1 class="page-title">Patient Planning</h1>
        <span class="phase-badge">Phase 2 - Planning</span>

        <!-- Patient Info Card -->
        <div class="patient-info-card">
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Unique ID</span>
                    <span class="info-value" id="uniqueId">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Name</span>
                    <span class="info-value" id="name">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Age / Sex</span>
                    <span class="info-value"><span id="age">-</span> / <span id="sex">-</span></span>
                </div>
                <div class="info-item">
                    <span class="info-label">Date</span>
                    <span class="info-value" id="date">-</span>
                </div>
            </div>
        </div>

        <!-- Planning Form -->
        <form class="form-section" id="planningForm">
            <h2 class="section-title">Planning Uploads</h2>

            <div class="upload-grid">
                <div class="upload-item">
                    <span class="upload-label">STL Image</span>
                    <button type="button" class="upload-btn" onclick="document.getElementById('stlInput').click()">
                        + Upload Files
                    </button>
                    <input type="file" id="stlInput" accept=".stl,.obj,.ply,image/*" multiple>
                    <div class="thumb-strip" id="stlStrip"></div>
                </div>

                <div class="upload-item">
                    <span class="upload-label">Plan PDF</span>
                    <button type="button" class="upload-btn" onclick="document.getElementById('pdfInput').click()">
                        + Upload PDF
                    </button>
                    <input type="file" id="pdfInput" accept=".pdf" multiple>
                    <div class="thumb-strip" id="pdfStrip"></div>
                </div>

                <div class="upload-item">
                    <span class="upload-label">Video</span>
                    <button type="button" class="upload-btn" onclick="document.getElementById('videoInput').click()">
                        + Upload Video
                    </button>
                    <input type="file" id="videoInput" accept="video/*" multiple>
                    <div class="thumb-strip" id="videoStrip"></div>
                </div>

                <div class="upload-item">
                    <span class="upload-label">Face 3D Image</span>
                    <button type="button" class="upload-btn" onclick="document.getElementById('face3dInput').click()">
                        + Upload Files
                    </button>
                    <input type="file" id="face3dInput" accept="image/*,.stl,.obj,.ply" multiple>
                    <div class="thumb-strip" id="face3dStrip"></div>
                </div>
            </div>

            <h2 class="section-title">3D Compare</h2>

            <div class="upload-grid">
                <div class="upload-item">
                    <span class="upload-label">Pre-Op Upper</span>
                    <button type="button" class="upload-btn"
                        onclick="document.getElementById('preOpUpperInput').click()">
                        + Upload Files
                    </button>
                    <input type="file" id="preOpUpperInput" accept=".stl,.obj,.ply,image/*" multiple>
                    <div class="thumb-strip" id="preOpUpperStrip"></div>
                </div>

                <div class="upload-item">
                    <span class="upload-label">Post-Op Upper</span>
                    <button type="button" class="upload-btn"
                        onclick="document.getElementById('postOpUpperInput').click()">
                        + Upload Files
                    </button>
                    <input type="file" id="postOpUpperInput" accept=".stl,.obj,.ply,image/*" multiple>
                    <div class="thumb-strip" id="postOpUpperStrip"></div>
                </div>

                <div class="upload-item">
                    <span class="upload-label">Pre-Op Lower</span>
                    <button type="button" class="upload-btn"
                        onclick="document.getElementById('preOpLowerInput').click()">
                        + Upload Files
                    </button>
                    <input type="file" id="preOpLowerInput" accept=".stl,.obj,.ply,image/*" multiple>
                    <div class="thumb-strip" id="preOpLowerStrip"></div>
                </div>

                <div class="upload-item">
                    <span class="upload-label">Post-Op Lower</span>
                    <button type="button" class="upload-btn"
                        onclick="document.getElementById('postOpLowerInput').click()">
                        + Upload Files
                    </button>
                    <input type="file" id="postOpLowerInput" accept=".stl,.obj,.ply,image/*" multiple>
                    <div class="thumb-strip" id="postOpLowerStrip"></div>
                </div>
            </div>

            <div class="form-actions">
                <div style="text-align: center;">
                    <button type="button" class="action-btn btn-back"
                        onclick="window.location.href='patient-planning-list.html'">
                        <svg width="35" height="35" viewBox="0 0 35 35">
                            <line x1="8" y1="8" x2="27" y2="27" stroke="white" stroke-width="3" />
                            <line x1="27" y1="8" x2="8" y2="27" stroke="white" stroke-width="3" />
                        </svg>
                    </button>
                    <div class="btn-label">Cancel</div>
                </div>

                <div style="text-align: center;">
                    <button type="submit" class="action-btn btn-save-next">
                        <svg width="35" height="35" viewBox="0 0 35 35">
                            <polyline points="8,18 15,25 27,10" fill="none" stroke="white" stroke-width="3" />
                        </svg>
                    </button>
                    <div class="btn-label">Save & Next</div>
                </div>
            </div>
        </form>
    </div>

    <script>
        let currentPatient = null;
        let activeUploads = {}; // tempId -> { xhr, btn, prop, originalText }
        let buttonActiveCounts = new Map(); // buttonElement -> count

        document.addEventListener('DOMContentLoaded', function () {
            const branch = localStorage.getItem('branch') || 'BRANCH';
            document.getElementById('branch-display').textContent = branch;

            const role = localStorage.getItem('role') || 'User';
            if (role !== 'ADMINISTRATOR') {
                const bookAppointmentLink = document.querySelector('a[href="book-appointment.html"]');
                if (bookAppointmentLink) bookAppointmentLink.style.display = 'none';
            }

            const raw = localStorage.getItem('currentPatient');
            if (!raw) {
                alert('No patient selected. Redirecting to Planning list.');
                window.location.href = 'patient-planning-list.html';
                return;
            }

            currentPatient = JSON.parse(raw);

            document.getElementById('uniqueId').textContent = currentPatient.bookingId || '-';
            document.getElementById('name').textContent = currentPatient.name || '-';
            document.getElementById('age').textContent = currentPatient.age || '-';
            document.getElementById('sex').textContent = currentPatient.sex || '-';
            document.getElementById('date').textContent = currentPatient.date || '-';

            setupFileUploads();

            if (currentPatient.planningStlPaths) renderThumbs(currentPatient.planningStlPaths, 'stlStrip', false, 'planningStlPaths');
            if (currentPatient.planningPdfPaths2) renderThumbs(currentPatient.planningPdfPaths2, 'pdfStrip', false, 'planningPdfPaths2');
            if (currentPatient.planningVideoPaths2) renderThumbs(currentPatient.planningVideoPaths2, 'videoStrip', true, 'planningVideoPaths2');
            if (currentPatient.planningFace3dPaths2) renderThumbs(currentPatient.planningFace3dPaths2, 'face3dStrip', false, 'planningFace3dPaths2');
            if (currentPatient.planningCompareUpperPaths) renderThumbs(currentPatient.planningCompareUpperPaths, 'preOpUpperStrip', false, 'comparePreOpUpper');
            if (currentPatient.comparePreOpUpper) renderThumbs(currentPatient.comparePreOpUpper, 'preOpUpperStrip', false, 'comparePreOpUpper');
            if (currentPatient.comparePostOpUpper) renderThumbs(currentPatient.comparePostOpUpper, 'postOpUpperStrip', false, 'comparePostOpUpper');
            if (currentPatient.comparePreOpLower) renderThumbs(currentPatient.comparePreOpLower, 'preOpLowerStrip', false, 'comparePreOpLower');
            if (currentPatient.comparePostOpLower) renderThumbs(currentPatient.comparePostOpLower, 'postOpLowerStrip', false, 'comparePostOpLower');

            document.getElementById('planningForm').addEventListener('submit', function (e) {
                e.preventDefault();
                saveAndProceed();
            });
        });

        function setupFileUploads() {
            const config = {
                stlInput: { prop: 'planningStlPaths', isVideo: false },
                pdfInput: { prop: 'planningPdfPaths2', isVideo: false },
                videoInput: { prop: 'planningVideoPaths2', isVideo: true },
                face3dInput: { prop: 'planningFace3dPaths2', isVideo: false },
                preOpUpperInput: { prop: 'comparePreOpUpper', isVideo: false },
                postOpUpperInput: { prop: 'comparePostOpUpper', isVideo: false },
                preOpLowerInput: { prop: 'comparePreOpLower', isVideo: false },
                postOpLowerInput: { prop: 'comparePostOpLower', isVideo: false }
            };

            Object.keys(config).forEach(id => {
                const input = document.getElementById(id);
                if (!input) return;
                const { prop, isVideo } = config[id];
                const stripId = id.replace('Input', 'Strip');

                input.addEventListener('change', async function () {
                    handleUploadProcess(this.files, this.previousElementSibling, prop, stripId, isVideo);
                    this.value = ''; // Reset input to allow same file selection
                });
            });
        }

        async function compressImage(file) {
            if (!file.type.startsWith('image/')) return file;
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 1200;
                        const MAX_HEIGHT = 1200;
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                        } else {
                            if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; }
                        }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        canvas.toBlob((blob) => {
                            resolve(new File([blob], file.name, { type: 'image/jpeg' }));
                        }, 'image/jpeg', 0.75);
                    };
                };
            });
        }

        async function handleUploadProcess(files, btn, dataProp, stripId, isVideo) {
            const fileObjects = Array.from(files);

            fileObjects.forEach(f => {
                const url = URL.createObjectURL(f);
                const tempId = 'temp_' + Math.random().toString(36).substr(2, 9);
                f.tempId = tempId;
                renderSingleThumb(url, stripId, isVideo, f.name, true, tempId, dataProp);
            });

            const uploadPromises = fileObjects.map(async (f) => {
                let fileToUpload = f;
                if (f.type.startsWith('image/')) {
                    fileToUpload = await compressImage(f);
                }

                try {
                    const serverPaths = await uploadFiles([fileToUpload], btn, f.tempId, dataProp);
                    if (serverPaths.length) {
                        currentPatient[dataProp] = (currentPatient[dataProp] || []).concat(serverPaths);
                        const localEl = document.getElementById(f.tempId);
                        if (localEl) localEl.remove();
                        renderThumbs(serverPaths, stripId, isVideo, dataProp);
                        await syncPatientToServer();
                    }
                } catch (err) {
                    console.error("Upload failed or canceled for:", f.name);
                    const localEl = document.getElementById(f.tempId);
                    if (localEl && !err.message.includes('Aborted')) {
                        localEl.style.opacity = '0.5';
                        localEl.style.border = '2px solid red';
                    }
                }
            });

            await Promise.all(uploadPromises);
        }

        async function syncPatientToServer() {
            const branch = localStorage.getItem('branch') || 'BRANCH';
            const key = `appointments_${branch}`;
            const appointments = JSON.parse(localStorage.getItem(key) || '[]');

            const updatedAppointments = appointments.map(appt => {
                if (appt.bookingId === currentPatient.bookingId) return { ...appt, ...currentPatient };
                return appt;
            });

            localStorage.setItem(key, JSON.stringify(updatedAppointments));
            localStorage.setItem('currentPatient', JSON.stringify(currentPatient));

            try {
                await fetch('/api/share', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(currentPatient)
                });
            } catch (e) { console.error("Auto-sync failed", e); }
        }

        async function uploadFiles(files, btnElement, tempId, dataProp) {
            if (!files || files.length === 0) return [];

            // Initialize button counter and track original text
            if (!buttonActiveCounts.has(btnElement)) {
                buttonActiveCounts.set(btnElement, 0);
                btnElement.dataset.originalText = btnElement.innerText;
            }
            buttonActiveCounts.set(btnElement, buttonActiveCounts.get(btnElement) + 1);
            const originalText = btnElement.dataset.originalText;

            return new Promise((resolve, reject) => {
                const formData = new FormData();
                files.forEach(f => formData.append('files', f));

                const xhr = new XMLHttpRequest();
                if (tempId) {
                    activeUploads[tempId] = {
                        xhr: xhr,
                        btn: btnElement,
                        originalText: originalText,
                        dataProp: dataProp
                    };
                }

                xhr.timeout = 30 * 60 * 1000;
                xhr.open('POST', '/upload', true);

                xhr.upload.onprogress = (e) => {
                    if (e.lengthComputable && btnElement) {
                        const percent = Math.round((e.loaded / e.total) * 100);
                        btnElement.innerText = `üîÑ ${percent}%`;
                        btnElement.style.background = `linear-gradient(90deg, #27ae60 ${percent}%, #14bfce ${percent}%)`;
                    }
                };

                const finishUpload = (status) => {
                    const count = buttonActiveCounts.get(btnElement) - 1;
                    buttonActiveCounts.set(btnElement, Math.max(0, count));

                    if (buttonActiveCounts.get(btnElement) <= 0) {
                        if (status === 'success') {
                            btnElement.innerText = '‚úÖ Done';
                            btnElement.style.background = '#27ae60';
                        } else if (status === 'error') {
                            btnElement.innerText = 'Retry';
                            btnElement.style.background = '#e74c3c';
                        } else {
                            // Aborted or other - just reset
                            btnElement.innerText = originalText;
                            btnElement.style.background = '#14bfce';
                            btnElement.disabled = false;
                            return;
                        }

                        setTimeout(() => {
                            if (buttonActiveCounts.get(btnElement) === 0) {
                                btnElement.innerText = originalText;
                                btnElement.style.background = '#14bfce';
                                btnElement.disabled = false;
                            }
                        }, 1500);
                    }
                };

                xhr.onload = () => {
                    if (xhr.status === 200) {
                        finishUpload('success');
                        resolve(JSON.parse(xhr.responseText).paths || []);
                    } else {
                        finishUpload('error');
                        reject(new Error('Upload failed'));
                    }
                };

                xhr.onerror = () => {
                    finishUpload('error');
                    reject(new Error('Network error'));
                };

                xhr.onabort = () => {
                    finishUpload('aborted');
                    reject(new Error('Aborted'));
                };

                btnElement.disabled = true;
                xhr.send(formData);

                xhr.onloadend = () => { if (tempId) delete activeUploads[tempId]; };
            });
        }

        function cancelUpload(tempId) {
            const entry = activeUploads[tempId];
            if (entry) {
                entry.xhr.abort();
                // delete happens in onloadend
            }
            const el = document.getElementById(tempId);
            if (el) el.remove();
        }

        function renderThumbs(paths, stripId, isVideo, dataProp) {
            const strip = document.getElementById(stripId);
            paths.forEach(path => {
                if (path && (path.startsWith('http') || path.startsWith('/uploads') || path.startsWith('blob:'))) {
                    renderSingleThumb(path, stripId, isVideo, null, false, null, dataProp);
                }
            });
        }

        function renderSingleThumb(path, stripId, isVideo, customName, isLocal = false, tempId, dataProp) {
            const strip = document.getElementById(stripId);

            // Avoid duplicates
            if (!isLocal) {
                const existing = Array.from(strip.querySelectorAll('[data-path]')).map(el => el.getAttribute('data-path'));
                if (existing.includes(path)) return;
            }

            const container = document.createElement('div');
            container.className = isLocal ? 'local-preview' : 'media-container';
            if (tempId) container.id = tempId;
            if (!isLocal) container.setAttribute('data-path', path);

            const fname = customName || path.split(/[/\\]/).pop();
            const ext = (fname.split('.').pop() || '').toLowerCase();
            const is3d = ['stl', 'obj', 'ply'].includes(ext);
            const isPdf = ext === 'pdf';
            const isVid = isVideo || ['mp4', 'webm', 'mov', 'avi', 'mkv'].includes(ext);

            if (is3d || isPdf || isVid || isLocal) {
                const chip = document.createElement('div');
                let displayPath = fname.length > 15 ? fname.substring(0, 12) + '...' : fname;
                if (isLocal) displayPath = "‚è≥ " + displayPath;
                chip.textContent = displayPath;
                chip.className = 'file-chip';
                chip.title = fname;
                if (!isLocal) chip.onclick = () => window.open(path, '_blank');
                container.appendChild(chip);
            } else {
                let mediaEl;
                mediaEl = document.createElement('img');
                mediaEl.src = path;
                mediaEl.style.width = '80px';
                mediaEl.style.height = '60px';
                mediaEl.style.objectFit = 'cover';
                mediaEl.style.borderRadius = '6px';
                mediaEl.onclick = () => window.open(path, '_blank');
                container.appendChild(mediaEl);
            }

            // Remove Button (always show if dataProp is provided, or if it's local)
            if (dataProp || isLocal) {
                const removeBtn = document.createElement('div');
                removeBtn.className = 'remove-btn';
                removeBtn.innerHTML = '&times;';
                removeBtn.onclick = (e) => {
                    e.stopPropagation();
                    if (isLocal) {
                        if (confirm('Cancel this upload?')) {
                            cancelUpload(tempId);
                        }
                    } else {
                        removeFile(path, dataProp, container);
                    }
                };
                container.appendChild(removeBtn);
            }

            strip.appendChild(container);
        }

        function removeFile(path, dataProp, element) {
            if (!confirm('Remove this file?')) return;
            currentPatient[dataProp] = (currentPatient[dataProp] || []).filter(p => p !== path);
            element.remove();
            syncPatientToServer();
        }

        function saveAndProceed() {
            syncPatientToServer().then(() => {
                const branch = localStorage.getItem('branch') || 'BRANCH';
                const key = `appointments_${branch}`;
                const appointments = JSON.parse(localStorage.getItem(key) || '[]');

                const updatedAppointments = appointments.map(appt => {
                    if (appt.bookingId === currentPatient.bookingId) {
                        return { ...appt, ...currentPatient, currentPhase: 'Phase 2 (Planning) - Completed', phase2Completed: true };
                    }
                    return appt;
                });
                localStorage.setItem(key, JSON.stringify(updatedAppointments));

                alert('Phase 2 completed successfully!\n\nYou can now proceed to Interaction phase when ready.');
                window.location.href = 'patient-planning-list.html';
            });
        }
    </script>
</body>

</html>